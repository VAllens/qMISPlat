function CPFlowSetFunctionRight(){CPFlowGlobal_InsId!=""&&CPFlowGlobal_TaskId==""?($("#btnSubmitFlow").hide(),$("#btnSaveForm").hide()):CPFlowGlobal_InsId==""&&CPFlowGlobal_TaskId==""&&CPFlowGlobal_FlowId!=""?($("#btnSaveForm").hide(),$("#btnSubmitFlow").show()):($("#btnSubmitFlow").show(),$("#btnSaveForm").show());CPFlowGlobal_FlowInfo.TaskCanFallbackCount>0&&$("#btnFallbackFlow").show();CPFlowGlobal_FlowInfo.CheckUserCanTakeBackFlow&&$("#btnTakeBackFlow").show();var n=!1;$.each($("#CPFlowButtonContainer").children("button"),function(t,i){if($(i).css("display")!="none"){n=!0;return}});n&&$("#CPFlowHeaderContainer").show()}function CPFlowSetContainerHeight(){$("#CPFlowHeaderContainer").css("display")!="none"?$("#CPFlowFormFrame").height($(window).height()-$("#CPFlowHeaderContainer").height()-$(".layui-tab-title").height()-34):$("#CPFlowFormFrame").height($(window).height()-$(".layui-tab-title").height()-34);$("#CPFlowFormFrame").width($(window).width()-3);$("#CPFlowLogFrame").height($("#CPFlowFormFrame").height());$("#CPFlowLogFrame").width($("#CPFlowFormFrame").width())}function CPFlowAfterFormSaveSuccess(n,t){CPFlowGlobal_ButtonClickType=="3"?CPFlowSaveFormEx(n):CPFlowGlobal_ButtonClickType=="1"?CPFlowGlobal_InsId==""?(t==""&&(t=CPFlowGlobal_FlowInfo.InsTitle),CPFlowStartFlowEx(n,t)):CPFlowSubmitFlowEx():CPFlowGlobal_ButtonClickType=="2"&&CPFlowFallbackFlowEx();CPFlowGlobal_ButtonClickType="1"}function CPFlowAfterFormSaveError(){CPFlowGlobal_ButtonClickType="1"}function CPFlowStartFlow(){document.getElementById("CPFlowFormFrame").contentWindow.CPFormSaveFormData()}function CPFlowStartFlowEx(n,t){var i={},r;i.CurUserId=CPCurUserId;i.CurUserIden=CPCurUserIden;i.FlowVerId=CPFlowGlobal_FlowInfo.Flow.FlowVerId;i.InsTitle=t;i.MainFormPK=n;r=CPWebRootPath+"/api/CPFlowEngine/StartFlow";$.ajax({type:"POST",url:r,data:JSON.stringify(i),contentType:"application/json",success:function(n){if(n.Result==!1)return alert("启动失败，详细信息："+n.ErrorMsg),!1;CPFlowGlobal_InsId=n.InsId;CPFlowGlobal_TaskId=n.TaskId;CPFlowSubmitFlow()}})}function CPFlowSubmitFlowDirect(){var n={},t;n.CurUserId=CPCurUserId;n.CurUserIden=CPCurUserIden;n.InsId=CPFlowGlobal_InsId;n.TaskId=CPFlowGlobal_TaskId;t=CPWebRootPath+"/api/CPFlowEngine/SubmitFlow";$.ajax({type:"POST",url:t,data:JSON.stringify(n),contentType:"application/json",success:function(n){if(n.Result==!1)return alert("操作失败，详细信息："+n.ErrorMsg),!1;var t="操作成功!";n.NewTaskUserNames!=""&&(t+="流程已转交用户【"+n.NewTaskUserNames+"】");alert(t);parent.CloseNewModel()}})}function CPFlowSubmitFlowToNext(){var n="/Plat/Flow/FlowSubmit?TaskId="+CPFlowGlobal_TaskId+"&InsId="+CPFlowGlobal_InsId;OpenNewModel(n,"提交流程",850,650)}function CPFlowSubmitFlow(){if(CPFlowGlobal_ButtonClickType="1",CPFlowGlobal_InsId==""){CPFlowStartFlow();return}document.getElementById("CPFlowFormFrame").contentWindow.CPFormSaveFormData()}function CPFlowSubmitFlowEx(){var n=CPWebRootPath+"/api/CPFlowEngine/CheckTaskIsCanDirectSubmit";n+="?TaskId="+CPFlowGlobal_TaskId+"&CurUserId="+CPCurUserId;n+="&CurUserIden="+CPCurUserIden;$.getJSON(n,function(n){if(n.Result==!1)return alert("检测是否需要转向提交界面时出错，错误信息如下："+n.ErrorMsg),!1;n.IsNeedFallback?CPFlowFallbackFlowDirect():n.IsCanDirectSubmit?CPFlowSubmitFlowDirect():CPFlowSubmitFlowToNext()})}function CPFlowSaveForm(){if(CPFlowGlobal_InsId=="")return alert("流程未发起，不允许保存表单！"),!1;CPFlowGlobal_ButtonClickType="3";document.getElementById("CPFlowFormFrame").contentWindow.CPFormSaveFormData()}function CPFlowSaveFormEx(n){var i=window.location.href,t;if(i.toLowerCase().indexOf("pkvalues=")!=-1){alert("保存成功！");return}t=CPWebRootPath+"/api/CPFlowEngine/SaveFlowFormInfo";t+="?InsId="+CPFlowGlobal_InsId+"&FormCode="+CPFlowGlobal_CurFormConfig.FormCode+"&FormPK="+n+"&CurUserId="+CPCurUserId;t+="&CurUserIden="+CPCurUserIden;$.getJSON(t,function(t){if(t.Result==!1)return alert(t.ErrorMsg),!1;$.each(CPFlowGlobal_FlowInfo.CurPhase.FormCol,function(t,i){if(i.FormId==CPFlowGlobal_CurFormConfig.FormId){var r=i.FormPageUrl;r.toLowerCase().indexOf("pkvalues=")==-1&&(r+="&PKValues="+n);i.FormPageUrl=r}});alert("保存成功！")})}function CPFlowFallbackFlowDirect(){var n=CPWebRootPath+"/api/CPFlowEngine/FallbackFlow";n+="?InsId="+CPFlowGlobal_InsId+"&TaskId="+CPFlowGlobal_TaskId+"&CurUserId="+CPCurUserId;n+="&CurUserIden="+CPCurUserIden;$.getJSON(n,function(n){if(n.Result==!1)return alert("驳回流程时出错，错误信息如下："+n.ErrorMsg),!1;var t="操作成功!";n.NewTaskUserNames!=""&&(t+="流程已驳回给用户【"+n.NewTaskUserNames+"】");alert(t);parent.CloseNewModel()})}function CPFlowFallbackFlowToNext(){var n="/Plat/Flow/FlowFallback?TaskId="+CPFlowGlobal_TaskId+"&InsId="+CPFlowGlobal_InsId;OpenNewModel(n,"驳回流程",550,450)}function CPFlowFallbackFlowEx(){CPFlowGlobal_FlowInfo.TaskCanFallbackCount>1?CPFlowFallbackFlowToNext():CPFlowFallbackFlowDirect()}function CPFlowFallbackFlow(){CPFlowGlobal_ButtonClickType="2";document.getElementById("CPFlowFormFrame").contentWindow.CPFormSaveFormData()}function TakeBackFlow(){if(confirm("您确实要取回流程吗？")){var n=CPWebRootPath+"/api/CPFlowEngine/TakeBackFlow";n+="?InsId="+CPFlowGlobal_InsId+"&CurUserId="+CPCurUserId;n+="&CurUserIden="+CPCurUserIden;$.getJSON(n,function(n){if(n.Result==!1)return alert("取回流程时出错，错误信息如下："+n.ErrorMsg),!1;alert("操作成功，流程已取回!");parent.CloseNewModel()})}}var CPFlowGlobal_FlowId=$.CPGetQuery("FlowId"),CPFlowGlobal_InsId,CPFlowGlobal_TaskId,CPFlowGlobal_FlowInfo,CPFlowGlobal_CurFormConfig,CPFlowGlobal_ButtonClickType;(CPFlowGlobal_FlowId==null||CPFlowGlobal_FlowId==undefined)&&(CPFlowGlobal_FlowId="");CPFlowGlobal_InsId=$.CPGetQuery("InsId");(CPFlowGlobal_InsId==null||CPFlowGlobal_InsId==undefined)&&(CPFlowGlobal_InsId="");CPFlowGlobal_TaskId=$.CPGetQuery("TaskId");(CPFlowGlobal_TaskId==null||CPFlowGlobal_TaskId==undefined)&&(CPFlowGlobal_TaskId="");CPFlowGlobal_ButtonClickType="1";layui.use("element",function(){var n=layui.element});$(function(){$("#btnSubmitFlow").click(function(){CPFlowSubmitFlow()});$("#btnSaveForm").click(function(){CPFlowSaveForm()});$("#btnFallbackFlow").click(function(){CPFlowFallbackFlow()});$("#btnTakeBackFlow").click(function(){TakeBackFlow()});var n=CPWebRootPath+"/api/CPFlowEngine/GetFlowInfo";n+="?FlowId="+CPFlowGlobal_FlowId+"&InsId="+CPFlowGlobal_InsId+"&TaskId="+CPFlowGlobal_TaskId+"&CurUserId="+CPCurUserId;n+="&CurUserIden="+CPCurUserIden;$.getJSON(n,function(n){if(n.Result==!1)return alert(n.ErrorMsg),!1;CPFlowGlobal_FlowInfo=n;console.log(CPFlowGlobal_FlowInfo);CPFlowSetFunctionRight();CPFlowSetContainerHeight();CPFlowGlobal_InsId==""?($("#spanInsTitleIcon").show(),$("#spanInsTitle").html(CPFlowGlobal_FlowInfo.Flow.FlowName)):($("#spanInsTitle").hide(),$("#spanInsTitleIcon").hide());var t="",i="";$.each(CPFlowGlobal_FlowInfo.CurPhase.FormCol,function(n,r){if(r.IsMainForm){t+='<li class="layui-this">'+r.FormTitle+"<\/li>";var u=r.FormPageUrl;u+="&FormUseInCPFlow=true";r.FormInitGroupCode!=null&&r.FormInitGroupCode!=""&&(u+="&InitGroupCode="+r.FormInitGroupCode);u=CPUrlAddWebRootPath(u);i=u;CPFlowGlobal_CurFormConfig=r}else t+="<li >"+r.FormTitle+"<\/li>"});t+="<li>流程<\/li>";$("#CPFlowFormFrame").attr("src",i);$(".layui-tab-title").html(t);layui.use("element",function(){var n=layui.element;n.on("tab(cpFlowTabBrief)",function(n){if($("#CPFlowLogFrame").is(":hidden")&&$("#CPFlowLogFrame").attr("src")!=""){$("#CPFlowLogFrame").show();$("#CPFlowFormFrame").hide();return}var t="",i=!1,r=CPFlowGlobal_CurFormConfig;if($.each(CPFlowGlobal_FlowInfo.CurPhase.FormCol,function(r,u){if(r==n.index){t=u.FormPageUrl;t+="&FormUseInCPFlow=true";u.FormInitGroupCode!=null&&u.FormInitGroupCode!=""&&(t+="&InitGroupCode="+u.FormInitGroupCode);u.FormRightGroupCode!=null&&u.FormRightGroupCode!=""&&(t+="&RightGroupCode="+u.FormRightGroupCode);t=CPUrlAddWebRootPath(t);CPFlowGlobal_CurFormConfig=u;i=!0;return}}),i){if($("#CPFlowLogFrame").is(":visible")&&r!=null&&r.Id==CPFlowGlobal_CurFormConfig.Id){$("#CPFlowFormFrame").show();$("#CPFlowLogFrame").hide();return}$("#CPFlowFormFrame").attr("src",t);$("#CPFlowFormFrame").show();$("#CPFlowLogFrame").hide()}else t="/Plat/Flow/FlowMonitor?InsId="+CPFlowGlobal_InsId+"&FlowId="+CPFlowGlobal_FlowId,t=CPUrlAddWebRootPath(t),$("#CPFlowLogFrame").attr("src",t),$("#CPFlowLogFrame").show(),$("#CPFlowFormFrame").hide()})})})});