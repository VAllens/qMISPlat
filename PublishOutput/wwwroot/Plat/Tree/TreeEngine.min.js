function CPGetContextFrame(){return document.getElementById("CPTreeFrame").contentWindow}function CPTreeSetFrameUrl(n){$("#CPTreeFrame").attr("src",CPWebRootPath+n)}function CPTreeSelectFirstNode(){var n=$("#CPTreeDiv").data("kendoTreeView"),t;n.dataSource.view().length<=0||(n.select(".k-item:first"),t=n.dataItem(n.select()),CPTreeNodeSelect(t,n.select()))}function CPTreeGetSelNodeData(){var n=[],t=$("#CPTreeDiv").data("kendoTreeView");return CPTreeCheckedNodeIds(t.dataSource.view(),n),n}function CPTreeCheckedNodeIds(n,t){for(var i=0;i<n.length;i++)n[i].checked&&t.push(n[i]),n[i].hasChildren&&CPTreeCheckedNodeIds(n[i].children.view(),t)}function CPTreeGetTreeInstance(){return $("#CPTreeDiv").data("kendoTreeView")}function CPTreeSetContainerWidth(){$("#CPTreeContainer").height($(window).height()-4);$("#CPTreeContainer").width($(window).width()-2);CPTreeGlobal_TreeObj.ShowType==2?$("#center-pane").hide():($("#CPTreeContainer").kendoSplitter({panes:[{collapsible:!0,size:CPTreeGlobal_TreeObj.LeftTreeWidth+"px"},{collapsible:!1}]}),$("#CPTreeFrame").height($(window).height()-8),$("#CPTreeFrame").width($(window).width()-$("#left-pane").width()-10))}function CPTreeNodeSelect(n,t){CPTreeGlobal_CurSelNodeData=n;CPTreeGlobal_CurSelNode=t;$.each(CPTreeGlobal_TreeObj.FuncCol,function(n,t){t.SourceId!=-1&&(t.SourceId==CPTreeGlobal_CurSelNodeData.TreeDataSourceId?$("#CPTree_FuncBtn_"+t.Id).show():$("#CPTree_FuncBtn_"+t.Id).hide())});CPTreeGlobal_TreeObj.SelectEventMethod!=""&&eval(CPTreeGlobal_TreeObj.SelectEventMethod)}function CPTreeDeleteNode(){if(CPTreeGlobal_CurSelNodeData==null)return alert("请先选中待删除的节点！"),!1;if(confirm("您确实要删除选中节点及其子节点吗？")){var n=CPWebRootPath+"/api/TreeEngine/DeleteTreeData";n+="?TreeDataSourceId="+CPTreeGlobal_CurSelNodeData.TreeDataSourceId;n+="&pkFieldValue="+CPTreeGlobal_CurSelNodeData.DeleteFieldValue;n+="&CurUserId="+CPCurUserId;n+="&CurUserIden="+CPCurUserIden;$.getJSON(n,function(n){if(n.Result==!1)return alert(n.ErrorMsg),!1;alert("删除成功！");try{var t=$("#CPTreeDiv").data("kendoTreeView"),r=CPTreeGlobal_CurSelNode,i=null,u=t.parent(r);t.remove(r);i=t.dataItem(u);i.loaded(!1);i.load();t.expand(u);CPTreeSetFrameUrl("about:_blank;")}catch(f){window.location.reload();return}})}}function CPTreeDragEnd(n){var u=$("#CPTreeDiv").data("kendoTreeView"),i=u.dataItem(n.sourceNode),e=u.dataItem(n.destinationNode),f,r,t;if(i.DeleteFieldValue==""){alert("数据源未配置表主键字段，无法将更改保存到数据库！");return}f=i.DeleteFieldValue;r="";r=n.dropPosition=="before"||n.dropPosition=="after"?-1:e.DeleteFieldValue;t=CPWebRootPath+"/api/TreeEngine/UpdateTreeDataParent";t+="?TreeDataSourceId="+i.TreeDataSourceId;t+="&SourcePKValue="+f;t+="&TargetPKValue="+r;t+="&CurUserId="+CPCurUserId;t+="&CurUserIden="+CPCurUserIden;$.getJSON(t,function(n){if(n.Result==!1)return alert(n.ErrorMsg),!1;alert("保存成功")})}function CPTreeNodedblClick(){CPTreeGlobal_TreeObj.DoubleClickEventMethod!=null&&CPTreeGlobal_TreeObj.DoubleClickEventMethod!=""&&eval(CPTreeGlobal_TreeObj.DoubleClickEventMethod)}function CPTreeOnLoadEx(){CPTreeGlobal_TreeObj.OnLoadEventMethod!=null&&CPTreeGlobal_TreeObj.OnLoadEventMethod!=""&&eval(CPTreeGlobal_TreeObj.OnLoadEventMethod)}function CPTreeRefresh(){if(CPTreeGlobal_TreeObj.DataLoadType==1){alert("当前数据加载模式为一次性全部加载，不支持局部刷新树节点，建议改成逐级加载模式");window.location.reload();return}if(CPTreeGlobal_CurSelNode==null){window.location.reload();return}var n=$("#CPTreeDiv").data("kendoTreeView"),r=CPTreeGlobal_CurSelNode,t=n.dataItem(r),i=n.parent(r);if(i==null){window.location.reload();return}if(t=n.dataItem(i),t==null){window.location.reload();return}t.loaded(!1);t.load();n.expand(i)}function CPTreeExpandAllNode(){if(CPTreeGlobal_TreeObj.DataLoadType==2){alert("当前数据加载模式为逐级加载，不允许使用全展开功能");return}for(var n=0,t=$("#CPTreeDiv").data("kendoTreeView");$(".k-i-expand").length>0&&n<10;)t.expand(".k-item"),n++}function CPTreeCollapseAllNode(){if(CPTreeGlobal_TreeObj.DataLoadType==2){alert("当前数据加载模式为逐级加载，不允许使用全收缩功能");return}var n=$("#CPTreeDiv").data("kendoTreeView");n.collapse(".k-item")}function CPTreeUpdateConfig(n){var t="/Plat/Tab/TabView?TabCode=Tab201710181518190005&TargetTreeId="+n;try{top.OpenNewModel(t,"修改配置",9e3,9e3)}catch(i){OpenNewModel(t,"修改配置",9e3,9e3)}}var CPTreeGlobal_TreeCode=$.CPGetQuery("TreeCode");(CPTreeGlobal_TreeCode==null||CPTreeGlobal_TreeCode==undefined)&&(CPTreeGlobal_TreeCode="");var CPTreeGlobal_TreeObj=null,CPTreeGlobal_CurSelNodeData=null,CPTreeGlobal_CurSelNode=null,CPTreeGlobal_AllLoadData=[];$(function(){for(var t,r=CPWebRootPath+"/api/TreeEngine/GetTreeInfo?TreeCode="+CPTreeGlobal_TreeCode+"&CurUserId="+CPCurUserId+"&CurUserIden="+CPCurUserIden,i=CPGetQueryString(),n=0;n<i.length;n++)(t=i[n].split("="),t[0].toLowerCase()!="treecode"&&t[0].toLowerCase()!="curuserid"&&t[0].toLowerCase()!="curuseriden")&&(r+="&"+i[n]);$.getJSON(r,function(n){var o,r,t;if(n.Result==!1)return alert(n.ErrorMsg),!1;o="";CPTreeGlobal_TreeObj=n.Tree;CPTreeSetContainerWidth();CPTreeGlobal_TreeObj.JSEx!=null&&CPTreeGlobal_TreeObj.JSEx!=""&&$("#divCPTreeJSContainer").html(CPTreeGlobal_TreeObj.JSEx);r="";$.each(CPTreeGlobal_TreeObj.FuncCol,function(n,t){var i="";t.SourceId!=-1&&(i=" display:none; ");r+='<button type="button" id="CPTree_FuncBtn_'+t.Id+'" class="CPTreeFuncBtn_Css" style="'+i+'"><i class="icon iconfont '+t.FuncIcon+'"  ><\/i><span>'+t.FuncTitle+"<\/span><\/button>"});$("#CPTreeButtonDiv").html(r);r==""&&$("#CPTreeButtonDiv").hide();$.each(CPTreeGlobal_TreeObj.FuncCol,function(n,t){$("#CPTree_FuncBtn_"+t.Id).kendoButton({click:function(){eval(t.JSMethod)}})});var i="CPTreeDiv",f=CPWebRootPath+"/api/TreeEngine/GetTreeData"+window.location.search,e=null,u=null;CPTreeGlobal_TreeObj.IsShowCheckBox&&(u=CPTreeGlobal_TreeObj.IsSelectChild?{checkChildren:!0}:{checkChildren:!1});CPTreeGlobal_TreeObj.DataLoadType==1?(t={},t.TreeCode=CPTreeGlobal_TreeCode,t.TreeDataSourceId=0,t.CurUserId=CPCurUserId,t.CurUserIden=CPCurUserIden,t.DataRowJSON="",$.ajax({type:"POST",url:f,data:JSON.stringify(t),contentType:"application/json",success:function(n){if(n.Result==!1)return alert("获取数据失败，详细信息："+n.ErrorMsg),!1;var t=new kendo.data.HierarchicalDataSource({data:n.DataCol,schema:{model:{id:"NodeId",hasChildren:"hasChildren",children:"items",checked:"checked"}}});$("#"+i).kendoTreeView({dragAndDrop:CPTreeGlobal_TreeObj.IsCanDrag,checkboxes:u,template:kendo.template($("#treeview-template").html()),dataSource:t,loadOnDemand:!1,dataBound:function(n){if(n.node==undefined){var t=$("#"+i).data("kendoTreeView");t.expand(".k-item:first");CPTreeOnLoadEx()}},select:function(n){var t=$("#"+i).data("kendoTreeView"),r=t.dataItem(n.node);CPTreeNodeSelect(r,n.node)},navigate:function(){},dragend:function(n){CPTreeDragEnd(n)}})}})):(e=new kendo.data.HierarchicalDataSource({transport:{read:{url:f,dataType:"json",type:"POST",contentType:"application/json"},parameterMap:function(n){var i=null,t;return n!=null&&n!=""&&$.each(CPTreeGlobal_AllLoadData,function(t,r){if(r.NodeId==n.NodeId){i=r;return}}),t={},t.TreeCode=CPTreeGlobal_TreeCode,i==null?(t.TreeDataSourceId=CPTreeGlobal_TreeObj.DataSourceCol[0].Id,t.DataRowJSON=""):(t.TreeDataSourceId=i.TreeDataSourceId,t.DataRowJSON=i.DataRowJSON),t.CurUserId=CPCurUserId,t.CurUserIden=CPCurUserIden,JSON.stringify(t)}},schema:{model:{id:"NodeId",hasChildren:"hasChildren",checked:"checked"},data:function(n){return $.each(n.DataCol,function(n,t){CPTreeGlobal_AllLoadData.push(t)}),n.DataCol}}}),$("#"+i).kendoTreeView({dragAndDrop:CPTreeGlobal_TreeObj.IsCanDrag,checkboxes:u,template:kendo.template($("#treeview-template").html()),dataSource:e,loadOnDemand:!0,dataBound:function(n){if(n.node==undefined){var t=$("#"+i).data("kendoTreeView");t.expand(".k-item:first");CPTreeOnLoadEx()}},select:function(n){var t=$("#"+i).data("kendoTreeView"),r=t.dataItem(n.node);CPTreeNodeSelect(r,n.node)},navigate:function(){},dragend:function(n){CPTreeDragEnd(n)}}))})});